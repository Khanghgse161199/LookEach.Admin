@page "/LookEach/Payment"
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager
@using LookEach.User.Component
@using LookEach.User.Model
@using LookEach.User.ViewModel
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Newtonsoft.Json
@inject ProtectedSessionStorage ProtectedSessionStore
@inject AuthenticationStateProvider AuthenticationStateProvider
<PageTitle>LookEach - Giỏ Hàng</PageTitle>

<style>
    .dxbl-checkbox:not(.dxbl-checkbox-switch):not(.dxbl-checkbox-radio):not(.dxbl-disabled):not(:disabled):not(.dxbl-readonly).dxbl-checkbox-checked .dxbl-checkbox-check-element, .dxbl-checkbox:not(.dxbl-checkbox-switch):not(.dxbl-checkbox-radio):not(.dxbl-disabled):not(:disabled):not(.dxbl-readonly).dxbl-checkbox-indeterminate .dxbl-checkbox-check-element {
        background-color: #47261D !important;
    }
</style>

<div class="page-title-area">
    <div class="container">
        <div class="page-title-content">
            <!-- <h2>Đăng ký</h2> -->
            <ul>
                <li><a href="/">Trang Chủ</a></li>
                <li style="color: #47261D;">Thanh Toán</li>
            </ul>
        </div>
    </div>
</div>

<section class="blog-details-area ptb-100" style="padding-bottom: 0;">
    <div class="container">
        <div class="user-actions">
            <i class="bx bx-log-in"></i>
            <a href="#" style="font-weight: 500;">Trở lại giỏ hàng</a>
        </div>
        <div class="row" id="tmp">
            <div class="col-lg-12 col-md-12">
                <div class="blog-details-desc">
                    <div class="article-content">
                        @{
                            if (_orders != null)
                            {
                                foreach (var groups in _orders)
                                {
                                    <blockquote class="wp-block-quote" style="height: 555px;">
                                        <div class="cart-table table-responsive">
                                            <table class="table table-bordered">
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <div>
                                                                <a href="#">@groups.ShopName.ToString()</a>
                                                            </div>
                                                        </td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td>
                                                            <div style="display: flex; justify-content: flex-end;padding-right: 2px;">
                                                                <a style="cursor: pointer;" class="default-btn">Xóa</a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    @foreach (var item in groups._cartGroupings)
                                                    {
                                                        <tr>
                                                            <td class="product-thumbnail">
                                                                <a href="#">
                                                                    <img src="@(item.Files != null ? NavigationManager.BaseUri + "api/Files/File?FileID=" + item.Files[0].FileId.ToString() : "0")" alt="item">
                                                                </a>
                                                            </td>
                                                            <td class="product-name" style="text-align: left;">
                                                                <a href="#">@item.ProductName</a>
                                                                <ul>
                                                                    <li>Màu sắc: <span>@(item.ColorChoices != null ? string.Join(", ", item.ColorChoices.Select(p => p.Name.Split('!')[0])) : "")</span></li>
                                                                    <li>Kích thước: <span>@item.SizeName</span></li>
                                                                    <li>Cất liệu: <span>@item.Material</span></li>
                                                                </ul>
                                                            </td>
                                                            <td class="product-price">
                                                                <span class="unit-amount">@item.Price.ToString("N0") VNĐ</span>
                                                            </td>
                                                            <td class="product-quantity">
                                                                <div class="input-counter">
                                                                    <span class="minus-btn"><i class="bx bx-minus"></i></span>
                                                                    <input type="text" min="1" value="@item.Amount">
                                                                    <span class="plus-btn"><i class="bx bx-plus"></i></span>
                                                                </div>
                                                            </td>
                                                            <td class="product-subtotal">
                                                                <span class="subtotal-amount">@((item.Amount * item.Price).ToString("N0")) VNĐ</span>
                                                                <a href="#" class="remove"><i class="bx bx-trash"></i></a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                            <div style="margin-top: 15px; display: flex;justify-content: space-between;align-items: center;">
                                                <div style="width: 327px;">
                                                    <aside class="widget-area">
                                                        <section class="widget widget_search">
                                                            <form class="search-form">
                                                                <label>
                                                                    <span class="screen-reader-text">Search for:</span>
                                                                    <input type="search" class="search-field"
                                                                           placeholder="Lưu ý cho người bán" @bind-value="groups.Note">
                                                                </label>
                                                            </form>
                                                        </section>
                                                    </aside>
                                                </div>
                                                <div style="text-align: left;">
                                                    <ul class="features-list" style="margin: 0;">
                                                        <li><i class="bx bx-badge-check"></i>Giảm 3k - Đơn tối thiểu 59k</li>
                                                    </ul>
                                                    <!-- <a href="#" class="co-check"><i class="fa-solid fa-recycle" style="color: #47261D;"></i><span style="padding-left: 7px;">Được đồng kiểm</span></a> -->
                                                </div>
                                            </div>
                                            <div style="margin-top: 15px; display: flex;justify-content: space-between;align-items: center;">
                                                <div id="dropdown-customization-target-container">
                                                    <DxButton CssClass="optional-btn" Click="() => _isOpen = !_isOpen">
                                                        <i class="fa-solid fa-ticket" style="color: #47261D;"></i>
                                                        <span style="padding-left: 2px;">
                                                            Chọn voucher giảm giá của
                                                            Shop
                                                        </span>
                                                    </DxButton>
                                                </div>
                                                <div class="product-subtotal">
                                                    <span class="subtotal-amount" style="color: #000000; font-weight: 600;">
                                                        Tổng:
                                                        @groups.Total.ToString("N0") VNĐ
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </blockquote>
                                }
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="track-order-area ptb-100" style="padding-top: 50px; padding-bottom: 100px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 col-md-7">

                <div class="track-order-content" style="margin: 40px 0 0 0;">
                    <div style="display: flex; justify-content: center;">
                        <div style="text-align:center;">
                            <h4><i class="fa-solid fa-ticket" style="color: #47261D;"></i> LookEach Voucher</h4>
                            <div class="form-group" id="dropdown-customization-target-container2" style="margin-top: 10px;">
                                <DxButton CssClass="optional-btn" Click="() => _visibility = !_visibility">
                                    <i class="fa-solid fa-ticket" style="color: #47261D;"></i>
                                    <span style="padding-left: 2px;">
                                        Chọn voucher giảm giá của hệ thống
                                    </span>
                                </DxButton>
                            </div>
                            <div class="form-group" style="margin-top: 15px;">
                                <div><i class="bx bx-badge-check" style="padding: 2px 7px 0 0;"></i>Giảm 3k - Đơn tối thiểu 59k </div>
                                <div><i class="bx bx-badge-check" style="padding: 2px 7px 0 0;"></i>Giảm 3k - Đơn tối thiểu 59k </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="track-order-content" style="margin: 25px 0 0 0;">
                    <h4><i class="fa-solid fa-location-dot" style="color: #47261D;"></i> Địa Chỉ Nhận Hàng</h4>
                    <form>
                        <div class="form-group">
                            <label>Tên Người Nhận</label>
                            <input type="text" class="form-control" @bind-value="_name">
                        </div>
                        <div class="form-group">
                            <label>Số Điện Thoại</label>
                            <input type="number" class="form-control" @bind-value="_phone">
                        </div>
                        <div class="form-group">
                            <label>Địa Chỉ</label>
                            <input type="text" class="form-control" @bind-value="_addrress">
                        </div>
                        Nhấn "Đặt hàng" đồng nghĩa với việc bạn đồng ý tuân theo <a href="#" style="color: #956235;">Điều khoản LookEach</a>
                    </form>
                </div>
            </div>
            <div class="col-lg-5 col-md-5">
                <div class="order-details">
                    <div class="payment-box" style="padding-top: 1px;margin-top: 0;">
                        <div class="cart-totals">
                            <h3>Tổng số giỏ hàng</h3>
                            <ul>
                                <li style="border-top:  1px solid #47261D;">Tổng tiền hàng <span>@_total.ToString("N0") VNĐ</span></li>
                                <li style="border-top:  1px solid #47261D;">Phí vận chuyển <span>30,000 VNĐ</span></li>
                                <li>Voucher giảm giá:<span>0 VNĐ</span></li>
                                <li>Giảm giá vận chuyển:<span>0 VNĐ</span></li>
                                <li>Tổng thanh toán <span>@((_total + 30000).ToString("N0")) VNĐ</span></li>
                            </ul>
                        </div>
                        <div class="payment-method" style="margin-top: 15px;">
                            <p>
                                <input type="radio" id="direct-bank-transfer" name="radio-group" checked>
                                <label for="direct-bank-transfer">Thanh toán khi nhận hàng</label>
                                Thanh toán khi nhận hàng mang lại sự an tâm cho người mua. Bạn chỉ phải thanh toán khi đã kiểm tra và nhận đúng sản phẩm mình đặt mua.
                            </p>
                            <p>
                                <input type="radio" id="paypal" name="radio-group">
                                <label for="paypal">PayPal</label>
                                PayPal cung cấp các biện pháp bảo mật hàng đầu, bảo vệ thông tin tài khoản - giao dịch của bạn và giúp bạn yên tâm hơn khi mua sắm trực tuyến.
                            </p>
                        </div>
                        <a style="cursor: pointer;" class="default-btn">Đặt Hàng</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>



<DxDropDown @bind-IsOpen="_isOpen"
            HeaderVisible="false"
            HeaderText="Header"
            PositionMode="DropDownPositionMode.Bottom"
            Width="327px"
            PositionTarget="#dropdown-customization-target-container"
            RestrictionTarget="#Navigation-DropDown-Overview"
            CloseMode="DropDownCloseMode.Close"
            PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate>
        <div>
            <aside class="widget-area">
                <section class="widget widget_search">
                    <div class="search-form">
                        <label>
                            <input type="search" class="search-field" placeholder="Tên, mã voucher...">
                        </label>
                        <button type="submit"><i class="bx bx-search-alt"></i></button>
                    </div>
                </section>
                <section class="widget widget_xton_posts_thumb">
                    <h3 class="widget-title">GenZ Store HN Voucher</h3>
                    <article class="item">
                        <a href="#" class="thumb">
                            <span class="fullimage cover bg1" role="img"></span>
                        </a>
                        <div class="info">
                            <span>HSD: 28.06.2024</span>
                            <h4 class="title usmall"><a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a></h4>
                        </div>
                        <div class="clear"></div>
                    </article>
                    <article class="item">
                        <a href="#" class="thumb">
                            <span class="fullimage cover bg2" role="img"></span>
                        </a>
                        <div class="info">
                            <span>HSD: 28.06.2024</span>
                            <h4 class="title usmall">
                                <a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a>
                            </h4>
                        </div>
                        <div class="clear"></div>
                    </article>
                    <article class="item">
                        <a href="#" class="thumb">
                            <span class="fullimage cover bg3" role="img"></span>
                        </a>
                        <div class="info">
                            <span>HSD: 28.06.2024</span>
                            <h4 class="title usmall">
                                <a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a>
                            </h4>
                        </div>
                        <div class="clear"></div>
                    </article>
                </section>
            </aside>
        </div>
    </BodyContentTemplate>
</DxDropDown>


<DxDropDown @bind-IsOpen="_visibility"
            HeaderVisible="false"
            HeaderText="Header"
            PositionMode="DropDownPositionMode.Bottom"
            Width="366px"
            PositionTarget="#dropdown-customization-target-container2"
            RestrictionTarget="#Navigation-DropDown-Overview"
            CloseMode="DropDownCloseMode.Close"
            PreventCloseOnPositionTargetClick="true"
            Context="popVoucher">
    <BodyContentTemplate>
        <div>
            <aside class="widget-area">
                <section class="widget widget_search" style="margin: 15px;">
                    <div class="search-form">
                        <label>
                            <input type="search" class="search-field" placeholder="Tên, mã voucher...">
                        </label>
                        <button type="submit"><i class="bx bx-search-alt"></i></button>
                    </div>
                </section>
                <section class="widget widget_xton_posts_thumb">
                    <p class="widget-title" style="font-size: 14px; color: #47261D;">
                        Mã Miễn Phí Vận Chuyển <br />
                        Có thể chọn 1 Voucher
                    </p>
                    <article class="item" style="display: flex; justify-content: flex-start; align-items: center;">
                        <div>
                            <a href="#" class="thumb">
                                <span class="fullimage cover bg1" role="img"></span>
                            </a>
                            <div class="info">
                                <span>HSD: 28.06.2024</span>
                                <h4 class="title usmall"><a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a></h4>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div>
                            <DxCheckBox Checked="true"></DxCheckBox>
                        </div>
                    </article>
                    <article class="item" style="display: flex; justify-content: flex-start; align-items: center;">
                        <div>
                            <a href="#" class="thumb">
                                <span class="fullimage cover bg1" role="img"></span>
                            </a>
                            <div class="info">
                                <span>HSD: 28.06.2024</span>
                                <h4 class="title usmall"><a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a></h4>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div>
                            <DxCheckBox Checked="false"></DxCheckBox>
                        </div>
                    </article>
                    <p class="widget-title" style="font-size: 14px; color: #47261D;">
                        Giảm giá <br />
                        Có thể chọn 1 Voucher
                    </p>
                    <article class="item" style="display: flex; justify-content: flex-start; align-items: center;">
                        <div>
                            <a href="#" class="thumb">
                                <span class="fullimage cover bg1" role="img"></span>
                            </a>
                            <div class="info">
                                <span>HSD: 28.06.2024</span>
                                <h4 class="title usmall"><a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a></h4>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div>
                            <DxCheckBox Checked="true"></DxCheckBox>
                        </div>
                    </article>
                    <article class="item" style="display: flex; justify-content: flex-start; align-items: center;">
                        <div>
                            <a href="#" class="thumb">
                                <span class="fullimage cover bg1" role="img"></span>
                            </a>
                            <div class="info">
                                <span>HSD: 28.06.2024</span>
                                <h4 class="title usmall"><a href="#">Giảm ₫3k Đơn Tối Thiểu ₫59k</a></h4>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div>
                            <DxCheckBox Checked="false"></DxCheckBox>
                        </div>
                    </article>
                </section>
            </aside>
        </div>
    </BodyContentTemplate>
</DxDropDown>


@code {
    private SPQuery.SPQuery _spq { get; set; }

    private List<CartDetailViewModel> _carts { get; set; } = new List<CartDetailViewModel>();

    private string _userId { get; set; } = "fb2f20f5-4948-4c5c-a87d-8b16e36c614f";

    private IEnumerable<IGrouping<string, CartDetailViewModel>> _cartGroupings { get; set; } = new List<IGrouping<string, CartDetailViewModel>>();

    private bool _isOpen { get; set; } = false;
    private bool _visibility { get; set; } = false;

    private List<CreateOrderModel> _orders { get; set; } = new List<CreateOrderModel>();
    private List<Voucher> _voucherShops { get; set; } = new List<Voucher>();
    private List<Voucher> _voucherSystems { get; set; } = new List<Voucher>();

    private decimal _total { get; set; } = 0;
    private string _name { get; set; } = string.Empty;
    private string _phone { get; set; } = string.Empty;
    private string _addrress { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _spq = new SPQuery.SPQuery(JSRuntime);
        await LoadDataAsync();
        await base.OnInitializedAsync();
    }

    private async Task LoadDataAsync()
    {
        _carts = await _spq.LoadCartDetailAsync(_userId);
        _cartGroupings = _carts.GroupBy(p => p.ShopName);

        foreach (var item in _cartGroupings)
        {
            double sum = item.Sum(p => (p.Amount * p.Price));
            _orders.Add(new CreateOrderModel
                {
                    ShopName = item.Key.ToString(),
                    Amount = Convert.ToDecimal(sum),
                    LevelOff = 0,
                    Note = string.Empty,
                    VoucherId = string.Empty,
                    Total = Convert.ToDecimal(sum),
                    _cartGroupings = item
                });
            _total = _total + Convert.ToDecimal(sum);
        }
    }
}
