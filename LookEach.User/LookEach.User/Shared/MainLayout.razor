@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager
@using LookEach.User.Component
@using LookEach.User.DTO
@using LookEach.User.Model
@using LookEach.User.ViewModel
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@inject ProtectedSessionStorage ProtectedSessionStore
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="top-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-12">
                <ul class="header-contact-info">
                    <li>Chào mừng đến với Look Each</li>
                    <li><i class="fa-solid fa-phone-volume"></i> <a href="tel:+0359285759">+84 35 928 5759</a></li>
                    <li><a href="#">Kênh người bán</a></li>
                </ul>
            </div>
            <div class="col-lg-6 col-md-12">
                <ul class="header-top-menu">
                    <li><a href="/LookEach/Profile"><i class="bx bxs-user"></i> Tài Khoản</a></li>
                    <li><a href="#"><i class="fa-solid fa-bell"></i> Thông báo</a></li>
                    <li>
                        <a href="#" style="padding-left: 25px;">
                            <i class="fa-solid fa-circle-question"></i> Hỗ
                            trợ
                        </a>
                    </li>
                    <li><a href="/LookEach/Login"><i class="bx bx-log-in"></i> Đăng nhập</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="navbar-area">
    <div class="xton-responsive-nav">
        <div class="container">
            <div class="xton-responsive-menu">
                <div class="logo">
                    <a href="/">
                        <img src="assets/img/11.png" class="main-logo" alt="logo">
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="xton-nav">
        <div class="container">
            <nav class="navbar navbar-expand-md navbar-light">
                <a class="navbar-brand" href="/">
                    <img src="assets/img/11.png" class="main-logo" alt="logo">
                </a>
                <div class="collapse navbar-collapse mean-menu">
                    <ul class="navbar-nav">
                        <li class="nav-item megamenu">
                            <a class="nav-link">
                                Shops<i class="bx bx-chevron-down"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="nav-item">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col">
                                                <h6 class="submenu-title">Cửa Hàng Thời Trang Tổng Hợp</h6>
                                                <ul class="megamenu-submenu">
                                                    @if (_shops != null)
                                                    {
                                                        for (int i = 0; i < 7; i++)
                                                        {
                                                            if (i >= _shops.Count()) break;
                                                            <li>
                                                                <a href="/LookEach/Shop/@_shops[i].Id">
                                                                    @_shops[i].Name
                                                                </a>
                                                            </li>
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Cửa Hàng Thời Trang Nam</h6>
                                                <ul class="megamenu-submenu">
                                                    @if (_shops != null)
                                                    {
                                                        for (int i = 7; i < 13; i++)
                                                        {
                                                            if (i >= _shops.Count()) break;
                                                            <li>
                                                                <a href="/LookEach/Shop/@_shops[i].Id">
                                                                    @_shops[i].Name
                                                                </a>
                                                            </li>
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Cửa Hàng Thời Trang Nữ</h6>
                                                <ul class="megamenu-submenu">
                                                    @if (_shops != null)
                                                    {
                                                        for (int i = 13; i < 19; i++)
                                                        {
                                                            if (i >= _shops.Count()) break;
                                                            <li>
                                                                <a href="/LookEach/Shop/@_shops[i].Id">
                                                                    @_shops[i].Name
                                                                </a>
                                                            </li>
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Phụ kiện Thời Trang</h6>
                                                <ul class="megamenu-submenu">
                                                    @if (_shops != null)
                                                    {
                                                        for (int i = 19; i < 25; i++)
                                                        {
                                                            if (i >= _shops.Count()) break;
                                                            <li>
                                                                <a href="/LookEach/Shop/@_shops[i].Id">
                                                                    @_shops[i].Name
                                                                </a>
                                                            </li>
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="brand-slides owl-carousel owl-theme" style="display:flex;justify-content: space-between;">
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img1.png" alt="image"></a>
                                            </div>
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img2.png" alt="image"></a>
                                            </div>
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img3.png" alt="image"></a>
                                            </div>
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img4.png" alt="image"></a>
                                            </div>
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img5.png" alt="image"></a>
                                            </div>
                                            <div class="brand-item">
                                                <a href="#"><img src="assets/img/brand/img6.png" alt="image"></a>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item megamenu">
                            <a href="#" class="nav-link">
                                Pages<i class="bx bx-chevron-down"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="nav-item">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col">
                                                <h6 class="submenu-title">Liên Kết</h6>
                                                <ul class="megamenu-submenu">
                                                    <li><a href="/LookEach/FAQ">FAQ's</a></li>
                                                    <li><a href="#" data-bs-toggle="modal" data-bs-target="#sidebarModal">Về Look Each</a></li>
                                                    <li><a href="/LookEach/CustomerServices">Dịch vụ khách hàng</a></li>
                                                    <li><a href="/LookEach/Contact">Liên hệ với chúng tôi</a></li>
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Loại Sản Phẩm</h6>
                                                <ul class="megamenu-submenu">
                                                    <li><a href="/LookEach/Product">Quần</a></li>
                                                    <li><a href="/LookEach/Product">Áo</a></li>
                                                    <li><a href="/LookEach/Product" style="pointer-events: none;">Giày Dép</a></li>
                                                    <li>
                                                        <a href="categories-4.html">
                                                            Tổng Hợp
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Cá Nhân</h6>
                                                <ul class="megamenu-submenu">
                                                    <li><a href="/LookEach/Cart">Giỏ hàng</a></li>
                                                    <li><a href="/LookEach/Order">Đơn hàng</a></li>
                                                </ul>
                                            </div>
                                            <div class="col">
                                                <h6 class="submenu-title">Tài Khoản</h6>
                                                <ul class="megamenu-submenu">
                                                    <li><a href="/LookEach/Login">Đặp nhập</a></li>
                                                    <li><a href="/LookEach/SignUp">Đăng ký</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                Blogs<i class="bx bx-chevron-down"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="nav-item">
                                    <a href="/LookEach/Blogs" class="nav-link blogs">
                                        <i class="bx bx-chevron-down"></i>
                                        <span>Nhật ký</span>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li class="nav-item">
                                            <a href="/LookEach/Blogs" class="nav-link">
                                                Hôm
                                                nay
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="/LookEach/Blogs" class="nav-link">
                                                Tuần
                                                này
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="/LookEach/Blogs" class="nav-link">
                                                Tháng
                                                này
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="/LookEach/Blogs" class="nav-link">
                                                Tất
                                                cả
                                            </a>
                                        </li>

                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>

                    <div class="others-option">
                        <div class="option-item">
                            <div class="search-btn-box">
                                <i class="search-btn bx bx-search-alt"></i>
                            </div>
                        </div>
                        <div class="option-item">
                            <div class="cart-btn">
                                <a style="cursor: pointer;" onclick="@(async ()=> OpenCartEven())">
                                    <i class="bx bx-shopping-bag"></i><span id="cart-count">@(_carts != null ? _carts.Count() : 0)</span>
                                </a>
                            </div>
                        </div>
                        <div class="option-item">
                            <div class="burger-menu" data-bs-toggle="modal" data-bs-target="#sidebarModal">
                                <span class="top-bar"></span>
                                <span class="middle-bar"></span>
                                <span class="bottom-bar"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</div>


<div class="search-overlay">
    <div class="d-table">
        <div class="d-table-cell">
            <div class="search-overlay-layer"></div>
            <div class="search-overlay-layer"></div>
            <div class="search-overlay-layer"></div>
            <div class="search-overlay-close">
                <span class="search-overlay-close-line"></span>
                <span class="search-overlay-close-line"></span>
            </div>
            <div class="search-overlay-form">
                <form>
                    <input type="text" class="input-search" placeholder="Search here...">
                    <button type="submit"><i class="bx bx-search-alt"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

@Body



<button id="cart-btn" data-bs-toggle="modal" data-bs-target="#shoppingCartModal" style="display:none;">Tmp</button>
<div class="modal right fade shoppingCartModal" id="shoppingCartModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true"><i class="bx bx-x"></i></span>
            </button>
            <div class="modal-body">
                <h3>Giỏ Hàng Của Tôi (@(_carts != null ? _carts.Count().ToString() : "0"))</h3>
                <div class="products-cart-content">
                    @if (_carts != null)
                    {
                        foreach (var item in _carts)
                        {
                            <div class="products-cart">
                                <div class="products-image">
                                    <a href="#"><img src="@(item.Files != null ? NavigationManager.BaseUri + "api/Files/File?FileID=" + item.Files[0].FileId.ToString() : "0")" alt="image"></a>
                                </div>
                                <div class="products-content">
                                    <h3><a href="#">@item.ProductName</a></h3>
                                    <span>@item.SizeName</span>
                                    <div class="products-price">
                                        <span>@item.Amount</span>
                                        <span>x</span>
                                        <span class="price">@((item.Price).ToString("N0")) VNĐ</span>
                                    </div>
                                    <a style="cursor: pointer;" onclick="@(async ()=> DeleteItem(item.ProductId,item.SizeId))" class="remove-btn"><i class="bx bx-trash"></i></a>
                                </div>
                            </div>
                        }
                    }
                </div>
                <div class="products-cart-subtotal">
                    <span>Tổng Cộng</span>
                    <span class="subtotal">@(_carts != null ? _carts.Sum(p => (p.Amount * p.Price)).ToString("N0") : "0") VNĐ</span>
                </div>
                <div class="products-cart-btn">
                    <a href="/LookEach/Payment" class="default-btn">Thanh Toán</a>
                    <a href="/LookEach/Cart" class="optional-btn">Xem Giỏ Hàng</a>
                </div>
            </div>
        </div>
    </div>
</div>



@code {
    private SPQuery.SPQuery _spq { get; set; }

    private string _userId { get; set; } = "fb2f20f5-4948-4c5c-a87d-8b16e36c614f";
    private List<CartModel> _carts { get; set; } = new List<CartModel>();
    private List<ShopDTO> _shops { get; set; } = new List<ShopDTO>();

    protected override async Task OnInitializedAsync()
    {
        _spq = new SPQuery.SPQuery(JSRuntime);
        _shops = await _spq.LoadShopAsync(_userId);
        await LoadDataAsync();
        await base.OnInitializedAsync();
    }

    private async Task LoadDataAsync()
    {
        _carts = await _spq.LoadCartAsync(_userId);
    }

    private async Task OpenCartEven()
    {
        await LoadDataAsync();
        await JSRuntime.InvokeVoidAsync("OpenCart");
    }

    private async Task DeleteItem(string proId, string sizeId)
    {
        bool delete = await _spq.DeteleItemCartAsync(_userId, proId, sizeId);
        if (!delete)
            await JSRuntime.InvokeVoidAsync("AnnountMessage", 2, "Lỗi hệ thống - Xóa không thành công!");
        else
        {
            await LoadDataAsync();
            await InvokeAsync(StateHasChanged);
        }
    }
}